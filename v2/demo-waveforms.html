<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<script type="text/javascript" src="../linear-scale.js"></script>
		<script type="text/javascript" src="../layers/layer.js"></script>
		<script type="text/javascript" src="../layers/waveforms-layer-v2.js"></script>
		<script type="text/javascript" src="../layers/segments-layer-v2.js"></script>
		<script type="text/javascript" src="../interaction-controllers/edit-controller.js"></script>
		<script type="text/javascript" src="../helpers/time-scroller.js"></script>

		<script src='https://mohayonao.github.io/timbre.js/timbre.dev.js'></script>
		<script src="https://mohayonao.github.io/timbre.js/misc/js/jquery.js"></script>
		<script src="https://mohayonao.github.io/timbre.js/misc/js/codemirror.js"></script>
		<script src="https://mohayonao.github.io/timbre.js/misc/js/javascript.js"></script>
		<script src="https://mohayonao.github.io/timbre.js/misc/js/xml.js"></script>
		<script src="https://mohayonao.github.io/timbre.js/misc/js/htmlmixed.js"></script>
		<script src="https://mohayonao.github.io/timbre.js/misc/js/subcollider.js"></script>
		<script src="https://mohayonao.github.io/timbre.js/misc/js/common.js"></script>
	</head>

	<body>
		<scroller id="scroller"></scroller>
		<ttrack id="track1" style="position: relative; height: 100px; width: 800px;">
		</ttrack>

		<script type="text/javascript">
			T("audio").load("http://mohayonao.github.io/timbre.js/misc/audio/drumkit.wav", function() {
			  var BD  = this.slice(   0,  500).set({bang:false});
			  var SD  = this.slice( 500, 1000).set({bang:false});
			  var HH1 = this.slice(1000, 1500).set({bang:false, mul:0.2});
			  var HH2 = this.slice(1500, 2000).set({bang:false, mul:0.2});
			  var CYM = this.slice(2000).set({bang:false, mul:0.2});
			  var scale = new sc.Scale([0,1,3,7,8], 12, "Pelog");

			  var P1 = [
			    [BD, HH1],
			    [HH1],
			    [HH2],
			    [],
			    [BD, SD, HH1],
			    [HH1],
			    [HH2],
			    [SD],
			  ].wrapExtend(128);

			  var P2 = sc.series(16);

			  var drum = T("lowshelf", {freq:110, gain:8, mul:0.6}, BD, SD, HH1, HH2, CYM).play();
			  var lead = T("saw", {freq:T("param")});
			  var vcf  = T("MoogFF", {freq:2400, gain:6, mul:0.1}, lead);
			  var env  = T("perc", {r:100});
			  var arp  = T("OscGen", {wave:"sin(15)", env:env, mul:0.5});

			  T("delay", {time:"BPM128 L4", fb:0.65, mix:0.35}, 
			    T("pan", {pos:0.2}, vcf), 
			    T("pan", {pos:T("tri", {freq:"BPM64 L1", mul:0.8}).kr()}, arp)
			  ).play();

			  T("interval", {interval:"BPM128 L16"}, function(count) {
			    var i = count % P1.length;
			    if (i === 0) CYM.bang();

			    P1[i].forEach(function(p) { p.bang(); });

			    if (Math.random() < 0.015) {
			      var j = (Math.random() * P1.length)|0;
			      P1.wrapSwap(i, j);
			      P2.wrapSwap(i, j);
			    }

			    var noteNum = scale.wrapAt(P2.wrapAt(count)) + 60;
			    if (i % 2 === 0) {
			      lead.freq.linTo(noteNum.midicps() * 2, "100ms");
			    }
			    arp.noteOn(noteNum + 24, 60);
			  }).start();
			});
		</script>

		<script type="text/javascript">
			function load_sample(audioCtx, url, callback) {
				var request = new XMLHttpRequest();
				request.open('GET', url, true);
				request.responseType = 'arraybuffer';
					request.onload = function() {
					audioCtx.decodeAudioData(request.response, function(decodedData) {
						callback(decodedData);
					});
				};
				request.send();
			}

			var data = [];

			for (var i=0; i<100; i++) {
				data.push({
					id: i, 
					time: i*10, 
					duration: 10, 
					bufferStart: (i)*50000 + 1, 
					bufferEnd: (i+1)*50000
				})
			}

			var dataIt = {
				index: undefined, 
				entry: { value: undefined, done: undefined }
			};
			dataIt.start = function(params) {
				this.index = 0;
			}.bind(dataIt);
			dataIt.next = function() {
				if (this.index >= data.length) {
					this.entry.value = undefined; 
					this.entry.done = true;
				} else {
					this.entry.value = data[this.index++];
					this.entry.done = false;
				}
				return this.entry;
			}.bind(dataIt);
			dataIt.stop = function() {
				this.index = undefined;
				this.entry.value = undefined;
				this.entry.done = undefined;
			}.bind(dataIt);
			

			var l1 = new WaveformsLayer({
				height: 100, width: 800
			});

			track1.appendChild(l1.layerDomEl);

			l1.get_datum = (hash) => {
				return data[hash];
			};

			l1.get_hash = (datum) => {
				return datum.id + "";
			};

			l1.accessor('channelData', (d, channelNumber) => {
				return d.audioBuffer.getChannelData(channelNumber);
			});

			l1.accessor('color', (d, elementName) => {
				switch (elementName) {
					case 'header': 
						return 'cyan';
					case 'right-handler': 
					case 'left-handler': 
					case 'bottom-handler': 
					case 'top-handler':  
						return 'blue';
					case 'waveform': 
						return 'black';
					case 'segment': 
						return 'rgb(255,255,255)';
				}
			});

			l1.accessor('width', (d, elementName) => {
				switch (elementName) {
					case 'right-handler': 
					case 'left-handler': 
					case 'bottom-handler': 
					case 'top-handler': 
						return 1;
					case 'waveform': 
						return 1;
				}
			});

			l1.accessor('text', (d) => {
				return "w" + d.id;
			});

			l1.accessor('zIndex', (d, elementName) => {
				switch (elementName) {
					case 'right-handler':
					case 'left-handler':
					case 'bottom-handler':
					case 'top-handler':
						return 3;
					case 'header':
						return 2;
					case 'waveform':
						return 1;
					case 'segment': 
						return d.id;
				}
			});

			l1.accessor('opacity', (d, elementName) => {
				if (elementName === 'header') 
					return 0.5;
				else 
					return 1;
			});

			l1.accessor('visible', (d, elementName) => {
				if (elementName === 'header')
					return false;
				else 
					return true;
			});

			var audioCtx = new AudioContext();
			load_sample(audioCtx, 'http://localhost/OLA-TS.js/07.%20Around%20The%20World.mp3', 
				(decodedData) => {
					let audioBuffer = decodedData;

					data.forEach((d) => d.audioBuffer = audioBuffer);

					data.forEach((datum) => l1.set(datum));
				});

			var editController = new EditController({ layer: l1 });

			var scroller = new TimeScroller({
				height: 10, width: 800
			});
			scroller.availableTimeRange = [0, 1000];
			scroller.add_target_layer(l1);
			document.getElementById('scroller').appendChild(scroller.layerDomEl);
			
		</script>
		
	</body>
</html>
